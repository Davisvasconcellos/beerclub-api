{
  "openapi": "3.0.0",
  "info": {
    "title": "BeerClub Event Guests API",
    "version": "1.0.0",
    "description": "Endpoints de convidados e check-in (staff e público)"
  },
  "servers": [
    { "url": "http://localhost:4000", "description": "Development server" }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "EventGuest": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "event_id": { "type": "integer" },
          "user_id": { "type": "integer", "nullable": true },
          "guest_name": { "type": "string" },
          "guest_email": { "type": "string", "format": "email", "nullable": true },
          "guest_phone": { "type": "string", "nullable": true },
          "guest_document_type": { "type": "string", "enum": ["rg", "cpf", "passport"], "nullable": true },
          "guest_document_number": { "type": "string", "nullable": true },
          "type": { "type": "string", "enum": ["normal", "vip", "premium"], "default": "normal" },
          "source": { "type": "string", "enum": ["invited", "walk_in"], "default": "invited" },
          "rsvp_confirmed": { "type": "boolean", "default": false },
          "rsvp_at": { "type": "string", "format": "date-time", "nullable": true },
          "invited_at": { "type": "string", "format": "date-time", "nullable": true },
          "invited_by_user_id": { "type": "integer", "nullable": true },
          "check_in_at": { "type": "string", "format": "date-time", "nullable": true },
          "check_in_method": { "type": "string", "enum": ["staff_manual", "google_login"], "nullable": true },
          "authorized_by_user_id": { "type": "integer", "nullable": true },
          "created_at": { "type": "string", "format": "date-time" },
          "updated_at": { "type": "string", "format": "date-time" }
        }
      },
      "GuestsBulkCreateRequest": {
        "type": "object",
        "properties": {
          "guests": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["guest_name"],
              "properties": {
                "guest_name": { "type": "string" },
                "guest_email": { "type": "string", "format": "email" },
                "guest_phone": { "type": "string" },
                "guest_document_type": { "type": "string", "enum": ["rg", "cpf", "passport"] },
                "guest_document_number": { "type": "string" },
                "type": { "type": "string", "enum": ["normal", "vip", "premium"], "default": "normal" },
                "source": { "type": "string", "enum": ["invited", "walk_in"], "default": "invited" },
                "rsvp_confirmed": { "type": "boolean" },
                "rsvp_at": { "type": "string", "format": "date-time" }
              }
            }
          }
        }
      }
    }
  },
  "tags": [
    { "name": "Event Guests", "description": "Operações administrativas de convidados e check-in" },
    { "name": "Events Public", "description": "Check-in público via Google" }
  ],
  "paths": {
    "/api/v1/events/{id}/guests": {
      "get": {
        "summary": "Listar convidados do evento",
        "tags": ["Event Guests"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" },
          { "in": "query", "name": "search", "schema": { "type": "string" } },
          { "in": "query", "name": "type", "schema": { "type": "string", "enum": ["normal", "vip", "premium"] } },
          { "in": "query", "name": "source", "schema": { "type": "string", "enum": ["invited", "walk_in"] } },
          { "in": "query", "name": "checked_in", "schema": { "type": "boolean" } },
          { "in": "query", "name": "checkin", "schema": { "type": "boolean" }, "description": "Alias de checked_in" },
          { "in": "query", "name": "rsvp", "schema": { "type": "boolean" } },
          { "in": "query", "name": "page", "schema": { "type": "integer", "default": 1 } },
          { "in": "query", "name": "page_size", "schema": { "type": "integer", "default": 20 } }
        ],
        "responses": {
          "200": {
            "description": "Lista de convidados",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Resposta com paginação, lista e estatísticas",
                    "value": {
                      "success": true,
                      "data": {
                        "guests": [
                          {
                            "id": 123,
                            "display_name": "Ana Silva",
                            "avatar_url": null,
                            "email": "ana@example.com",
                            "document": { "type": "cpf", "number": "123.456.789-00" },
                            "phone": "+55 11 99999-0000",
                            "type": "normal",
                            "origin_status": "pre_list",
                            "rsvp": true,
                            "rsvp_at": "2025-11-08T15:00:00.000Z",
                            "check_in_at": null,
                            "checked_in": false,
                            "check_in_method": null
                          }
                        ],
                        "stats": {
                          "total_guests": 200,
                          "rsvp_count": 120,
                          "checkin_count": 95,
                          "by_source": { "invited": 150, "walk_in": 50 },
                          "by_type": { "normal": 160, "vip": 30, "premium": 10 },
                          "by_check_in_method": { "google": 25, "staff_manual": 65, "invited_qr": 5 }
                        }
                      },
                      "meta": { "total": 1, "page": 1, "page_size": 20, "pages": 1 }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "Evento não encontrado" }
        }
      },
      "post": {
        "summary": "Criar convidados (bulk)",
        "tags": ["Event Guests"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/GuestsBulkCreateRequest" },
              "examples": {
                "Exemplo": {
                  "summary": "Criar dois convidados",
                  "value": {
                    "guests": [
                      {
                        "guest_name": "Ana Silva",
                        "guest_email": "ana@example.com",
                        "type": "vip",
                        "source": "invited",
                        "rsvp_confirmed": true,
                        "rsvp_at": "2025-11-08T15:00:00.000Z"
                      },
                      {
                        "guest_name": "Bruno Lima",
                        "guest_phone": "+55 11 90000-0000",
                        "guest_document_type": "cpf",
                        "guest_document_number": "987.654.321-00",
                        "type": "normal",
                        "source": "invited"
                      }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Convidados criados",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Retorno com convidados criados",
                    "value": {
                      "success": true,
                      "data": {
                        "guests": [
                          {
                            "id": 501,
                            "event_id": 42,
                            "guest_name": "Ana Silva",
                            "guest_email": "ana@example.com",
                            "type": "vip",
                            "source": "invited",
                            "rsvp_confirmed": true,
                            "rsvp_at": "2025-11-08T15:00:00.000Z",
                            "invited_at": "2025-11-09T12:00:00.000Z"
                          },
                          {
                            "id": 502,
                            "event_id": 42,
                            "guest_name": "Bruno Lima",
                            "guest_phone": "+55 11 90000-0000",
                            "guest_document_type": "cpf",
                            "guest_document_number": "987.654.321-00",
                            "type": "normal",
                            "source": "invited",
                            "rsvp_confirmed": false,
                            "invited_at": "2025-11-09T12:00:00.000Z"
                          }
                        ]
                      }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "Evento não encontrado" },
          "409": {
            "description": "Duplicidade por email/documento/usuário",
            "content": {
              "application/json": {
                "examples": {
                  "Duplicidade email": {
                    "summary": "Email já está em uso no evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Email já está em uso neste evento",
                      "details": [ { "field": "guest_email", "issue": "duplicate" } ]
                    }
                  },
                  "Duplicidade documento": {
                    "summary": "Documento já está em uso no evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Documento já está em uso neste evento",
                      "details": [ { "field": "guest_document_number", "issue": "duplicate" } ]
                    }
                  },
                  "Duplicidade usuário": {
                    "summary": "Usuário já associado ao evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Usuário já está associado a este evento",
                      "details": [ { "field": "user_id", "issue": "duplicate" } ]
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/events/{id}/guests/{guestId}": {
      "patch": {
        "summary": "Atualizar convidado",
        "tags": ["Event Guests"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" },
          { "in": "path", "name": "guestId", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "guest_email": { "type": "string", "format": "email" },
                  "guest_phone": { "type": "string" },
                  "guest_document_type": { "type": "string", "enum": ["rg", "cpf", "passport"] },
                  "guest_document_number": { "type": "string" },
                  "type": { "type": "string", "enum": ["normal", "vip", "premium"] },
                  "rsvp_confirmed": { "type": "boolean" },
                  "rsvp_at": { "type": "string", "format": "date-time", "nullable": true },
                  "check_in_at": { "type": "string", "format": "date-time", "nullable": true, "description": "Se enviado com data e sem check_in_method/authorized_by_user_id, serão definidos por padrão: check_in_method='staff_manual' e authorized_by_user_id=usuário do token. Se enviado como null, check-in será removido e campos relacionados zerados." },
                  "check_in_method": { "type": "string", "enum": ["google", "staff_manual", "invited_qr"], "description": "Opcional no PATCH; se omitido quando check_in_at é enviado, assume 'staff_manual'" },
                  "authorized_by_user_id": { "type": "integer", "description": "Opcional no PATCH; se omitido quando check_in_at é enviado, assume o usuário do token" }
                }
              },
              "examples": {
                "Exemplo": {
                  "summary": "Atualização de RSVP e telefone",
                  "value": {
                    "guest_phone": "+55 21 98888-7777",
                    "rsvp_confirmed": true,
                    "rsvp_at": "2025-11-08T18:30:00.000Z"
                  }
                },
                "Remover RSVP": {
                  "summary": "Reset de confirmação de presença",
                  "value": {
                    "rsvp_at": null,
                    "rsvp_confirmed": false
                  }
                },
                "Remover check-in": {
                  "summary": "Reset de check-in",
                  "value": {
                    "check_in_at": null
                  }
                },
                "Check-in manual (defaults)": {
                  "summary": "Definir check-in sem enviar metadados (usa defaults)",
                  "value": {
                    "check_in_at": "2025-11-10T21:45:00.000Z"
                  }
                },
                "Check-in manual": {
                  "summary": "Definir check-in com metadados",
                  "value": {
                    "check_in_at": "2025-11-10T21:45:00.000Z",
                    "check_in_method": "staff_manual",
                    "authorized_by_user_id": 100
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Convidado atualizado",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Retorno com convidado atualizado",
                    "value": {
                      "success": true,
                      "data": {
                        "guest": {
                          "id": 501,
                          "event_id": 42,
                          "guest_name": "Ana Silva",
                          "guest_email": "ana@example.com",
                          "guest_phone": "+55 21 98888-7777",
                          "rsvp_confirmed": true,
                          "rsvp_at": "2025-11-08T18:30:00.000Z",
                          "type": "vip"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "Evento/Convidado não encontrado" },
          "409": {
            "description": "Duplicidade por email/documento/usuário",
            "content": {
              "application/json": {
                "examples": {
                  "Duplicidade email": {
                    "summary": "Email já está em uso no evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Email já está em uso neste evento",
                      "details": [ { "field": "guest_email", "issue": "duplicate" } ]
                    }
                  },
                  "Duplicidade documento": {
                    "summary": "Documento já está em uso no evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Documento já está em uso neste evento",
                      "details": [ { "field": "guest_document_number", "issue": "duplicate" } ]
                    }
                  },
                  "Duplicidade usuário": {
                    "summary": "Usuário já associado ao evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Usuário já está associado a este evento",
                      "details": [ { "field": "user_id", "issue": "duplicate" } ]
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/events/{id}/checkin/lookup": {
      "post": {
        "summary": "Buscar convidados (portaria)",
        "tags": ["Event Guests"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "type": "object", "properties": { "query": { "type": "string" } } },
              "examples": {
                "Exemplo": {
                  "summary": "Busca por nome parcial",
                  "value": { "query": "ana" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Matches de convidados",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Retorno com lista de possíveis convidados",
                    "value": {
                      "success": true,
                      "data": {
                        "guests": [
                          { "id": 501, "guest_name": "Ana Silva", "guest_email": "ana@example.com", "check_in_at": null },
                          { "id": 502, "guest_name": "Anita Souza", "guest_email": null, "check_in_at": null }
                        ]
                      }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "Evento não encontrado" }
        }
      }
    },
    "/api/v1/events/{id}/checkin/confirm": {
      "post": {
        "summary": "Confirmar check-in (portaria)",
        "tags": ["Event Guests"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "type": "object", "required": ["guest_id"], "properties": { "guest_id": { "type": "integer" } } },
              "examples": {
                "Exemplo": {
                  "summary": "Confirmar check-in do convidado 501",
                  "value": { "guest_id": 501 }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Check-in confirmado",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Retorno com convidado checado",
                    "value": {
                      "success": true,
                      "data": {
                        "guest": {
                          "id": 501,
                          "guest_name": "Ana Silva",
                          "check_in_at": "2025-11-09T14:20:00.000Z",
                          "check_in_method": "staff_manual",
                          "authorized_by_user_id": 10
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "Evento/Convidado não encontrado" }
        }
      }
    },
    "/api/v1/events/{id}/checkin/manual": {
      "post": {
        "summary": "Cadastro rápido + check-in (portaria)",
        "tags": ["Event Guests"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["guest_name"],
                "properties": {
                  "guest_name": { "type": "string" },
                  "guest_phone": { "type": "string" },
                  "guest_document_type": { "type": "string", "enum": ["rg", "cpf", "passport"] },
                  "guest_document_number": { "type": "string" },
                  "type": { "type": "string", "enum": ["normal", "vip", "premium"], "default": "normal" }
                }
              },
              "examples": {
                "Exemplo": {
                  "summary": "Cadastrar walk-in e checar",
                  "value": {
                    "guest_name": "Convidado Walk-in",
                    "guest_phone": "+55 11 95555-0000",
                    "guest_document_type": "rg",
                    "guest_document_number": "12.345.678-9",
                    "type": "normal"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Convidado criado e check-in realizado",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Retorno com convidado walk-in",
                    "value": {
                      "success": true,
                      "data": {
                        "guest": {
                          "id": 700,
                          "guest_name": "Convidado Walk-in",
                          "guest_phone": "+55 11 95555-0000",
                          "type": "normal",
                          "source": "walk_in",
                          "check_in_at": "2025-11-09T14:25:00.000Z",
                          "check_in_method": "staff_manual",
                          "authorized_by_user_id": 10
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "Evento não encontrado" },
          "409": {
            "description": "Duplicidade por email/documento/usuário",
            "content": {
              "application/json": {
                "examples": {
                  "Duplicidade documento": {
                    "summary": "Documento já está em uso no evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Documento já está em uso neste evento",
                      "details": [ { "field": "guest_document_number", "issue": "duplicate" } ]
                    }
                  },
                  "Duplicidade usuário": {
                    "summary": "Usuário já associado ao evento",
                    "value": {
                      "error": "Duplicate entry",
                      "message": "Usuário já está associado a este evento",
                      "details": [ { "field": "user_id", "issue": "duplicate" } ]
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/events/{id}/checkin/google": {
      "post": {
        "summary": "Check-in via Google (público)",
        "tags": ["Events Public"],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string", "format": "uuid" }, "description": "id_code do evento (UUID)" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "type": "object", "required": ["idToken"], "properties": { "idToken": { "type": "string" } } },
              "examples": {
                "Exemplo": {
                  "summary": "Check-in com idToken do Google",
                  "value": { "idToken": "eyJhbGciOiJSUzI1NiIsImtpZCI6Ij..." }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Check-in realizado",
            "content": {
              "application/json": {
                "examples": {
                  "Exemplo": {
                    "summary": "Retorno com convidado checkado via Google",
                    "value": {
                      "success": true,
                      "data": {
                        "guest": {
                          "id": 800,
                          "guest_name": "Usuário Google",
                          "guest_email": "user@gmail.com",
                          "type": "normal",
                          "source": "walk_in",
                          "check_in_at": "2025-11-09T14:30:00.000Z",
                          "check_in_method": "google_login"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": { "description": "Token Google inválido" },
          "404": { "description": "Evento não encontrado" },
          "409": { "description": "Convidado já checkado" }
        }
      }
    }
  }
}